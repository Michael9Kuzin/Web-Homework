
#  **Главные изменения — коротко**

| Что изменилось                                  | Почему старый код ломался                                | Как решено в новом                       |
| ----------------------------------------------- | -------------------------------------------------------- | ---------------------------------------- |
| ❗ Убрали автоклик кнопки при загрузке           | jQuery ещё не успевал загрузиться → ошибка               | Теперь студент сам нажимает кнопку       |
| ❗ Добавлен fetch-fallback при отсутствии jQuery | Старый код ломался, если CDN jQuery не загрузился        | Новый код работает даже без jQuery       |
| Улучшены сообщения статуса                      | Студент не понимал, в чём ошибка                         | Теперь видно: сеть, сервер, парсинг, CDN |
| Добавлены console.log и отладка                 | Ошибка была «тихой»                                      | Теперь виден источник проблемы           |
| Добавлены обработчики ошибок XHR/fetch          | Старый код не ловил сетевые ошибки                       | Теперь всё ловит и выводит               |
| Улучшена функция renderProducts()               | Старый код ломался, если нет `name`                      | Поддержка brand/model, XSS-защита        |
| Убран плохой автозапуск jQuery AJAX             | jQuery не успевал загрузиться                            | Проблема устранена                       |
| Исправлена HTML-строка внутри innerHTML         | Там был синтаксический баг `<h3>${...}</h3>` без кавычек | Новый код корректен                      |

---

# **Самые критичные отличия, которые и ломали старый код**

## **1. Старый код запускался раньше, чем загружался jQuery**

Старый:

```js
window.addEventListener('load', function() { 
  document.getElementById('loadBtn').click(); 
});
```

Если CDN jQuery *не загрузился вовремя* →
нажатие кнопки вызывает `loadProductsJQuery()` →
`window.jQuery === undefined` →
ошибка → пустой экран.

✔ В новом коде автоклик отключён
✔ Студент вручную нажимает кнопку
✔ jQuery гарантированно уже успел загрузиться

---

## **2. Старый код НЕ имел запасного варианта для jQuery**

Старый:

```js
if (!window.jQuery) {
  setStatus('jQuery не загружен');
  return;
}
```

→ и всё. Лабораторная падает.

Новый:

```js
if (!window.jQuery) {
  setStatus('jQuery не найден, fallback → fetch (jQuery-эмуляция)');
  fetch(...);
}
```

✔ Даже без jQuery код работает
✔ Лабораторная проходит
✔ Ошибки CDN больше не ломают проект

---

## **3. Исправлена ошибка в innerHTML старого кода**

Старый фрагмент был БРАКОМ:

```js
div.innerHTML = <h3>${escapeHtml(p.name)}</h3><div>ID: ${p.id}</div>
```

Нет кавычек!
Это вообще **невалидный JavaScript**.

Новый:

```js
div.innerHTML = `<h3>${name}</h3><div>ID: ${id}</div><div class="price">$${price}</div>`;
```

✔ Шаблонная строка
✔ Корректно экранируется
✔ Безопасно

ЭТО одна из причин, почему старый код «не работал».

---

## **4. Новый код показывает, загружен ли jQuery**

Добавлено:

```js
console.log('app.js loaded — jQuery present?', !!window.jQuery);
```

→ Сразу видно источник проблемы:
если `false`, значит CDN не загрузился.

---

# Ключевые изменения внутри AJAX-части

### Старый jQuery AJAX:

* без тайм-аута
* без обработки ошибки ответа
* без проверки JSON

### Новый AJAX:

* timeout: 10 sec
* полноценные `.done()` и `.fail()`
* логирование ошибок

### Старый Native XHR:

* не ловил сетевые ошибки
* падал при parse error

### Новый XHR:

* `.onerror`
* try/catch
* console.error

---

# **ИТОГ — почему старый код НЕ работал**

1. ❌ jQuery иногда НЕ успевал загрузиться
2. ❌ Автоклик кнопки запускал AJAX слишком рано
3. ❌ В шаблоне HTML была синтаксическая ошибка
4. ❌ Не было fallback-механизма
5. ❌ Ошибки не отображались, всё ломалось «тихо»

---

# Новый код работает, потому что:

* загружает данные БЕЗ зависимости от CDN
* корректно выводит ошибки
* правильно рендерит HTML
* безопасно экранирует строки
* не стартует раньше времени
* имеет запасной механизм AJAX


